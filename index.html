<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Stocks - Multi-Utilisateurs</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- STYLES INCHANGÉS -->
    <style>/* … même contenu que dans votre fichier original … */</style>
</head>
<body>
    <!-- HTML INCHANGÉ -->
    <!-- … tout le bloc <body> identique à votre fichier … -->

    <!-- SUPABASE -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = "https://fguubktsgnongnwypdpa.supabase.co";
        const SUPABASE_KEY = "sb_publishable_aruAeGgV20l704ugx3ZtuQ_pSLO57v0";
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        /* ============================================================
           REMPLACEMENT DES ACCÈS LOCALSTORAGE PAR SUPABASE
           ============================================================ */

        /* ---------- UTILISATEURS (serveuses + admin/caissière) ---------- */
        let users = {}; // sera chargé depuis Supabase
        async function loadUsers() {
            const { data, error } = await supabaseClient.from('users').select('*');
            if (!error && data) {
                users = {};
                data.forEach(u => { users[u.username] = u; });
            }
        }
        async function saveUser(username, userData) {
            const { error } = await supabaseClient
                .from('users')
                .upsert({ username, ...userData }, { onConflict: 'username' });
            if (!error) users[username] = userData;
        }
        async function deleteUserDb(username) {
            const { error } = await supabaseClient
                .from('users')
                .delete()
                .eq('username', username);
            if (!error) delete users[username];
        }

        /* ---------- VENTES ---------- */
        let sales = [];
        async function loadSales() {
            const { data, error } = await supabaseClient
                .from('sales')
                .select('*')
                .order('id', { ascending: false });
            if (!error && data) sales = data;
        }
        async function saveSaleDb(sale) {
            const { error } = await supabaseClient.from('sales').insert([sale]);
            if (!error) sales.unshift(sale);
        }
        async function updateSaleDb(id, sale) {
            const { error } = await supabaseClient.from('sales').update(sale).eq('id', id);
            if (!error) {
                const idx = sales.findIndex(s => s.id === id);
                if (idx > -1) sales[idx] = { ...sales[idx], ...sale };
            }
        }

        /* ---------- FONDS DE CAISSE ---------- */
        let cashFund = 0;
        async function loadCashFund() {
            const { data, error } = await supabaseClient
                .from('cash_fund')
                .select('amount, date')
                .order('id', { ascending: false })
                .limit(1)
                .single();
            if (!error && data) {
                if (data.date === getCurrentDate()) cashFund = data.amount;
                else cashFund = 0;
            }
        }
        async function saveCashFundDb(amount) {
            const { error } = await supabaseClient
                .from('cash_fund')
                .insert([{ amount, date: getCurrentDate() }]);
            if (!error) cashFund = amount;
        }

        /* ---------- STOCK PRODUITS ---------- */
        async function loadProductStock() {
            const { data, error } = await supabaseClient.from('product_stock').select('*');
            if (!error && data) {
                data.forEach(row => {
                    const prod = productCatalog.find(p => p.code === row.code);
                    if (prod) {
                        prod.stock = row.stock;
                        prod.alertThreshold = row.alert_threshold;
                    }
                });
            }
        }
        async function saveProductStock(code, stock, alertThreshold) {
            await supabaseClient
                .from('product_stock')
                .upsert({ code, stock, alert_threshold: alertThreshold }, { onConflict: 'code' });
        }

        /* ---------- MOUVEMENTS DE STOCK ---------- */
        let stockMovements = [];
        async function loadStockMovements() {
            const { data, error } = await supabaseClient
                .from('stock_movements')
                .select('*')
                .order('id', { ascending: false });
            if (!error && data) stockMovements = data;
        }
        async function saveStockMovementDb(movement) {
            const { error } = await supabaseClient.from('stock_movements').insert([movement]);
            if (!error) stockMovements.unshift(movement);
        }

        /* ---------- DÉPENSES ---------- */
        let expenses = [];
        async function loadExpensesDb() {
            const { data, error } = await supabaseClient
                .from('expenses')
                .select('*')
                .order('id', { ascending: false });
            if (!error && data) expenses = data;
        }
        async function saveExpenseDb(expense) {
            const { error } = await supabaseClient.from('expenses').insert([expense]);
            if (!error) expenses.unshift(expense);
        }
        async function deleteExpenseDb(id) {
            const { error } = await supabaseClient.from('expenses').delete().eq('id', id);
            if (!error) expenses = expenses.filter(e => e.id !== id);
        }

        /* ============================================================
           ADAPTATION DES FONCTIONS ORIGINALES
           ============================================================ */

        /* Remplacement des appels initApp */
        async function initApp() {
            await loadUsers();
            await loadSales();
            await loadCashFund();
            await loadProductStock();
            await loadStockMovements();
            await loadExpensesDb();

            /* même logique de rôle qu’avant */
            document.getElementById('currentUser').textContent = currentUser.name;
            document.getElementById('serverNameDisplay').textContent = currentUser.name;
            const badge = document.getElementById('userBadge');
            badge.className = 'user-badge role-' + currentUser.role;

            if (currentUser.role === 'admin') {
                /* … tout le bloc inchangé … */
                document.getElementById('infoBanner').innerHTML = '<i class="fas fa-info-circle"></i> <strong>Mode Administrateur :</strong> Gestion complète du système.';
                document.getElementById('btnCatalog').style.display = 'flex';
                document.getElementById('btnAdd').style.display = 'none';
                document.getElementById('btnProductTable').style.display = 'none';
                document.getElementById('btnUsers').style.display = 'flex';
                document.getElementById('btnReset').style.display = 'flex';
                document.getElementById('btnStock').style.display = 'flex';
                document.getElementById('btnServerStats').style.display = 'flex';
                document.getElementById('cashFundCard').style.display = 'flex';
                document.getElementById('searchSection').style.display = 'block';
                document.getElementById('reportButtons').style.display = 'flex';
                document.getElementById('serverDashboard').style.display = 'none';
                document.getElementById('expenseSection').style.display = 'block';
            } else if (currentUser.role === 'cashier') {
                /* … idem … */
                document.getElementById('infoBanner').innerHTML = '<i class="fas fa-info-circle"></i> <strong>Mode Caissière :</strong> Consultation des ventes et rapports.';
                document.getElementById('btnCatalog').style.display = 'none';
                document.getElementById('btnAdd').style.display = 'none';
                document.getElementById('btnProductTable').style.display = 'none';
                document.getElementById('btnUsers').style.display = 'none';
                document.getElementById('btnReset').style.display = 'none';
                document.getElementById('btnStock').style.display = 'flex';
                document.getElementById('btnServerStats').style.display = 'none';
                document.getElementById('cashFundCard').style.display = 'flex';
                document.getElementById('searchSection').style.display = 'block';
                document.getElementById('reportButtons').style.display = 'flex';
                document.getElementById('serverDashboard').style.display = 'none';
                document.getElementById('expenseSection').style.display = 'block';
                if (!cashFund) document.getElementById('cashFundModal').classList.add('active');
            } else if (currentUser.role === 'server') {
                /* … idem … */
                document.getElementById('infoBanner').innerHTML = '<i class="fas fa-info-circle"></i> <strong>Mode Serveuse :</strong> Tableau de bord personnel.';
                document.getElementById('btnCatalog').style.display = 'none';
                document.getElementById('btnAdd').style.display = 'none';
                document.getElementById('btnProductTable').style.display = 'flex';
                document.getElementById('btnUsers').style.display = 'none';
                document.getElementById('btnReset').style.display = 'none';
                document.getElementById('btnStock').style.display = 'none';
                document.getElementById('btnServerStats').style.display = 'none';
                document.getElementById('cashFundCard').style.display = 'none';
                document.getElementById('searchSection').style.display = 'none';
                document.getElementById('reportButtons').style.display = 'none';
                document.getElementById('serverDashboard').style.display = 'block';
                document.getElementById('expenseSection').style.display = 'none';
            }

            renderSales();
            updateStats();
            updateExpenseStats();
            updateCashFundDisplay();
            if (currentUser.role === 'server') updateServerDashboard();
            checkAlerts();
        }

        /* Remplacement login */
        async function login(event) {
            event.preventDefault();
            const username = document.getElementById('username').value.toLowerCase().trim();
            const password = document.getElementById('password').value;
            await loadUsers();
            if (users[username] && users[username].password === password) {
                currentUser = { username, role: users[username].role, name: users[username].name };
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('appPage').classList.add('active');
                await initApp();
            } else {
                alert('Identifiants incorrects !');
            }
        }

        /* Remplacement saveCashFund */
        async function saveCashFund() {
            const amount = parseFloat(document.getElementById('cashFundAmount').value);
            if (!amount || amount < 0) return alert('Montant invalide');
            await saveCashFundDb(amount);
            updateCashFundDisplay();
            document.getElementById('cashFundModal').classList.remove('active');
            alert('Fonds de caisse enregistré : ' + amount.toLocaleString('fr-FR') + ' FCFA');
        }

        /* Remplacement saveSale (quick & normal) */
        async function saveSale() {
            /* … même vérifications qu’avant … */
            const serverName = document.getElementById('serverName').value.trim();
            if (!serverName) return alert('Nom de serveuse requis');

            const selectedProducts = [];
            const stockUpdates = {};
            for (const code in productQuantities) {
                for (let i = 0; i < productQuantities[code]; i++) selectedProducts.push(code);
                stockUpdates[code] = productQuantities[code];
            }
            if (selectedProducts.length === 0) return alert('Sélectionnez au moins un produit');

            for (const code in stockUpdates) {
                const prod = productCatalog.find(p => p.code === code);
                if (!prod || prod.stock < stockUpdates[code]) return alert('Stock insuffisant pour ' + prod.name);
            }

            const totalAmount = parseFloat(document.getElementById('saleTotal').value) || 0;
            const paymentOM = parseFloat(document.getElementById('paymentOM').value) || 0;
            const paymentMOMO = parseFloat(document.getElementById('paymentMOMO').value) || 0;
            const paymentCASH = parseFloat(document.getElementById('paymentCASH').value) || 0;
            if (paymentOM + paymentMOMO + paymentCASH !== totalAmount) return alert('Répartition paiement incorrecte');

            /* mise à jour stock */
            for (const code in stockUpdates) {
                const prod = productCatalog.find(p => p.code === code);
                prod.stock -= stockUpdates[code];
                await saveProductStock(code, prod.stock, prod.alertThreshold);
                await saveStockMovementDb({
                    date: getCurrentDate(),
                    time: getCurrentTime(),
                    type: 'SORTIE',
                    productCode: code,
                    productName: prod.name,
                    quantity: stockUpdates[code],
                    reference: 'VENTE-' + Date.now(),
                    comment: 'Vente automatique',
                    user: currentUser.name,
                    stockAfter: prod.stock
                });
            }

            const saleData = {
                serverName,
                serverUsername: currentUser.username,
                quantity: selectedProducts.length,
                products: selectedProducts,
                unitPrice: Math.round(totalAmount / selectedProducts.length),
                totalAmount,
                paymentOM,
                paymentMOMO,
                paymentCASH,
                date: getCurrentDate(),
                time: getCurrentTime(),
                dateTime: getCurrentDate() + ' ' + getCurrentTime()
            };

            if (editingId) {
                saleData.id = editingId;
                await updateSaleDb(editingId, saleData);
            } else {
                await saveSaleDb(saleData);
                lastReceipt = saleData;
            }

            renderSales();
            updateStats();
            if (currentUser.role === 'server') updateServerDashboard();
            closeSaleModal();
            checkAlerts();
            if (!editingId && currentUser.role === 'server') {
                setTimeout(() => { if (confirm('Imprimer le reçu ?')) printReceiptData(saleData); }, 500);
            }
        }

        /* Remplacement saveQuickSale */
        window.saveQuickSale = async function () {
            const items = [];
            const stockUpdates = {};
            for (const c in quickData) {
                if (quickData[c].qty > 0) {
                    for (let i = 0; i < quickData[c].qty; i++) items.push(c);
                    stockUpdates[c] = quickData[c].qty;
                }
            }
            if (items.length === 0) return alert('Aucun produit sélectionné');

            for (const code in stockUpdates) {
                const prod = productCatalog.find(p => p.code === code);
                if (!prod || prod.stock < stockUpdates[code]) return alert('Stock insuffisant pour ' + prod.name);
            }

            const total = parseInt(document.getElementById('quickTotal').textContent.replace(/\s/g, '')) || 0;
            const om = parseInt(document.getElementById('quickOM').value) || 0;
            const momo = parseInt(document.getElementById('quickMOMO').value) || 0;
            const cash = parseInt(document.getElementById('quickCASH').value) || 0;
            if (om + momo + cash !== total) return alert('Répartition paiement incorrecte');

            for (const code in stockUpdates) {
                const prod = productCatalog.find(p => p.code === code);
                prod.stock -= stockUpdates[code];
                await saveProductStock(code, prod.stock, prod.alertThreshold);
                await saveStockMovementDb({
                    date: getCurrentDate(),
                    time: getCurrentTime(),
                    type: 'SORTIE',
                    productCode: code,
                    productName: prod.name,
                    quantity: stockUpdates[code],
                    reference: 'VENTE-' + Date.now(),
                    comment: 'Vente rapide',
                    user: currentUser.name,
                    stockAfter: prod.stock
                });
            }

            const saleData = {
                serverName: currentUser.name,
                serverUsername: currentUser.username,
                quantity: items.length,
                products: items,
                unitPrice: Math.round(total / items.length),
                totalAmount: total,
                paymentOM: om,
                paymentMOMO: momo,
                paymentCASH: cash,
                date: getCurrentDate(),
                time: getCurrentTime(),
                dateTime: getCurrentDate() + ' ' + getCurrentTime()
            };
            await saveSaleDb(saleData);
            lastReceipt = saleData;
            renderSales();
            updateStats();
            if (currentUser.role === 'server') updateServerDashboard();
            closeQuickSale();
            checkAlerts();
            setTimeout(() => { if (confirm('Voulez-vous imprimer le reçu ?')) printReceiptData(saleData); }, 500);
        };

        /* Remplacement gestion utilisateurs */
        window.saveNewUser = async function () {
            const username = document.getElementById('newUsername').value.trim().toLowerCase();
            const fullname = document.getElementById('newUserFullname').value.trim();
            const password = document.getElementById('newUserPassword').value.trim();
            if (!username || !fullname || !password) return alert('Remplissez tous les champs');
            if (password.length < 6) return alert('6 caractères minimum');
            if (users[username]) return alert('Nom d\'utilisateur déjà utilisé');
            await saveUser(username, { password, role: 'server', name: fullname });
            alert('Serveuse ajoutée');
            renderUsersList();
            closeAddUserModal();
        };
        window.updateUser = async function () {
            const username = document.getElementById('editUsername').value;
            const fullname = document.getElementById('editUserFullname').value.trim();
            const password = document.getElementById('editUserPassword').value.trim();
            if (!fullname) return alert('Nom complet requis');
            if (password && password.length < 6) return alert('6 caractères minimum');
            const updates = { name: fullname };
            if (password) updates.password = password;
            await saveUser(username, { ...users[username], ...updates });
            alert('Utilisateur modifié');
            renderUsersList();
            closeEditUserModal();
        };
        window.deleteUser = async function (username) {
            if (!confirm('Supprimer cette serveuse ?')) return;
            await deleteUserDb(username);
            renderUsersList();
        };

        /* Remplacement dépenses */
        window.saveExpense = async function () {
            const date = document.getElementById('expenseDate').value || getCurrentDate();
            const libelle = document.getElementById('expenseLibelle').value.trim();
            const reference = document.getElementById('expenseReference').value.trim();
            const quantity = parseInt(document.getElementById('expenseQuantity').value) || 1;
            const unitPrice = parseFloat(document.getElementById('expenseUnitPrice').value) || 0;
            if (!libelle) return alert('Libellé requis');
            await saveExpenseDb({ date, libelle, reference, quantity, unitPrice, total: quantity * unitPrice });
            renderExpenses();
            updateExpenseStats();
            closeExpenseModal();
        };
        window.deleteExpense = async function (index) {
            if (!confirm('Supprimer cette dépense ?')) return;
            const id = expenses[index].id;
            await deleteExpenseDb(id);
            renderExpenses();
            updateExpenseStats();
        };

        /* Remplacement stock */
        window.saveStockEntry = async function () {
            const productCode = document.getElementById('stockProduct').value;
            const quantity = parseInt(document.getElementById('stockQuantity').value);
            const reference = document.getElementById('stockReference').value.trim();
            const comment = document.getElementById('stockComment').value.trim();
            if (!productCode || quantity <= 0) return alert('Sélectionnez un produit et une quantité valide');
            const prod = productCatalog.find(p => p.code === productCode);
            if (!prod) return;
            prod.stock += quantity;
            await saveProductStock(productCode, prod.stock, prod.alertThreshold);
            await saveStockMovementDb({
                date: getCurrentDate(),
                time: getCurrentTime(),
                type: 'ENTREE',
                productCode,
                productName: prod.name,
                quantity,
                reference,
                comment,
                user: currentUser.name,
                stockAfter: prod.stock
            });
            alert('Stock mis à jour : ' + prod.name + ' (+' + quantity + ') = ' + prod.stock);
            closeAddStockModal();
            renderStockTable();
            checkStockAlerts();
        };

        /* Remplacement reset */
        window.resetAllData = async function () {
            if (!confirm('Tout réinitialiser ? Cela supprime TOUTES les données.')) return;
            await supabaseClient.from('sales').delete().neq('id', 0);
            await supabaseClient.from('expenses').delete().neq('id', 0);
            await supabaseClient.from('stock_movements').delete().neq('id', 0);
            await supabaseClient.from('product_stock').delete().neq('id', 0);
            await supabaseClient.from('cash_fund').delete().neq('id', 0);
            sales = []; expenses = []; stockMovements = []; cashFund = 0;
            productCatalog.forEach(p => { p.stock = 50; p.alertThreshold = 10; });
            renderSales(); updateStats(); updateExpenseStats(); updateCashFundDisplay();
            alert('Données réinitialisées.');
        };

        /* ============================================================
           RESTE DU SCRIPT ORIGINAL (NON MODIFIÉ)
           ============================================================ */
        /* … copier/coller ici tout le reste du bloc <script> de votre fichier original … */
        /* seuls les appels localStorage ont été remplacés plus haut */
    </script>
</body>
</html>
