<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Stocks - ART'RISE</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #e3f2fd 50%, #e8eaf6 100%); min-height: 100vh; }

        .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 2rem; }
        .login-box { background: white; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); max-width: 450px; width: 100%; overflow: hidden; }
        .login-header { background: linear-gradient(135deg, #5c6bc0, #3f51b5); color: white; padding: 2.5rem; text-align: center; }
        .login-header i { font-size: 3rem; margin-bottom: 1rem; }
        .login-header h1 { font-size: 1.8rem; margin-bottom: 0.5rem; }
        .login-header p { opacity: 0.9; font-size: 0.9rem; }
        .login-body { padding: 2.5rem; }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; color: #2c3e50; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.9rem; border: 2px solid #ecf0f1; border-radius: 10px; font-size: 1rem; transition: border 0.3s; font-family: inherit; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #5c6bc0; }
        .btn-login { width: 100%; padding: 1rem; background: linear-gradient(135deg, #5c6bc0, #3f51b5); color: white; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-login:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(92,107,192,0.4); }

        .app-container { display: none; }
        .app-container.active { display: block; }

        header { background: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-bottom: 4px solid #5c6bc0; }
        .header-content { max-width: 1600px; margin: 0 auto; padding: 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .logo-section { display: flex; align-items: center; gap: 1rem; }
        .logo { background: linear-gradient(135deg, #5c6bc0, #3f51b5); padding: 1rem; border-radius: 12px; box-shadow: 0 4px 8px rgba(92,107,192,0.3); }
        .logo i { color: white; font-size: 2rem; }
        h1 { color: #2c3e50; font-size: 2rem; }
        .subtitle { color: #7f8c8d; font-size: 0.9rem; }
        .user-badge { background: #5c6bc0; color: white; padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem; }
        .role-admin { background: linear-gradient(135deg, #ef5350, #e53935); }
        .role-cashier { background: linear-gradient(135deg, #66bb6a, #43a047); }
        .role-server { background: linear-gradient(135deg, #42a5f5, #1e88e5); }

        .header-buttons { display: flex; gap: 0.75rem; flex-wrap: wrap; }
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; display: flex; align-items: center; gap: 0.5rem; transition: all 0.3s; font-weight: 500; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .btn-primary { background: linear-gradient(135deg, #5c6bc0, #3f51b5); color: white; }
        .btn-success { background: linear-gradient(135deg, #66bb6a, #43a047); color: white; }
        .btn-info { background: linear-gradient(135deg, #42a5f5, #1e88e5); color: white; }
        .btn-warning { background: linear-gradient(135deg, #ffa726, #fb8c00); color: white; }
        .btn-danger { background: linear-gradient(135deg, #ef5350, #e53935); color: white; }

        .container { max-width: 1600px; margin: 0 auto; padding: 2rem; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; transition: all 0.3s; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 8px 16px rgba(0,0,0,0.15); }
        .stat-info h3 { color: #7f8c8d; font-size: 0.85rem; margin-bottom: 0.5rem; font-weight: 500; }
        .stat-info p { color: #2c3e50; font-size: 1.5rem; font-weight: bold; }
        .stat-icon { padding: 1rem; border-radius: 12px; color: white; font-size: 1.5rem; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .stat-icon.blue { background: linear-gradient(135deg, #42a5f5, #1e88e5); }
        .stat-icon.green { background: linear-gradient(135deg, #66bb6a, #43a047); }
        .stat-icon.orange { background: linear-gradient(135deg, #ffa726, #fb8c00); }
        .stat-icon.red { background: linear-gradient(135deg, #ef5350, #e53935); }
        .stat-icon.purple { background: linear-gradient(135deg, #ab47bc, #8e24aa); }
        .stat-icon.teal { background: linear-gradient(135deg, #26a69a, #00897b); }

        .search-section { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 2rem; }
        .search-box { position: relative; }
        .search-box i { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #bdc3c7; }
        .search-box input { width: 100%; padding: 1rem 1rem 1rem 3rem; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 1rem; transition: border 0.3s; }
        .search-box input:focus { outline: none; border-color: #5c6bc0; }

        .table-container { background: white; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); overflow: hidden; margin-bottom: 2rem; }
        .table-header { display: flex; justify-content: space-between; align-items: center; padding: 1.5rem; border-bottom: 2px solid #ecf0f1; }
        .table-header h3 { color: #2c3e50; font-size: 1.3rem; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: linear-gradient(135deg, #5c6bc0, #3f51b5); color: white; }
        th { padding: 1rem 0.75rem; text-align: left; font-weight: 600; font-size: 0.85rem; white-space: nowrap; }
        tbody tr { border-bottom: 1px solid #ecf0f1; transition: background 0.2s; }
        tbody tr:nth-child(even) { background: #f8f9fa; }
        tbody tr:hover { background: #e3f2fd; }
        td { padding: 0.75rem; font-size: 0.85rem; }
        .product-code { background: #e8eaf6; padding: 0.25rem 0.5rem; border-radius: 4px; font-family: monospace; font-weight: 600; }
        .payment-badge { padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; }
        .payment-om { background: #ffe0b2; color: #e65100; }
        .payment-momo { background: #fff9c4; color: #f57f17; }
        .payment-cash { background: #c8e6c9; color: #2e7d32; }

        .action-btns { display: flex; gap: 0.5rem; justify-content: center; }
        .action-btn { padding: 0.5rem; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
        .action-btn:hover { transform: scale(1.1); }
        .btn-edit { background: #e3f2fd; color: #1976d2; }
        .btn-delete { background: #ffebee; color: #d32f2f; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: 1rem; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 16px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        .modal-header { background: linear-gradient(135deg, #5c6bc0, #3f51b5); color: white; padding: 1.5rem; border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { font-size: 1.5rem; }
        .modal-body { padding: 2rem; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 1rem; padding: 0 2rem 2rem 2rem; }
        .btn-cancel { background: white; color: #7f8c8d; border: 2px solid #ecf0f1; }
        .no-data { text-align: center; padding: 3rem; color: #95a5a6; }
        .no-data i { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }

        .alert { padding: 1rem; margin: 1rem 0; border-radius: 8px; border-left: 4px solid; }
        .alert-danger { background: #ffebee; border-color: #f44336; color: #d32f2f; }
        .alert-warning { background: #fff3e0; border-color: #ff9800; color: #e65100; }
        .alert-success { background: #e8f5e9; border-color: #4caf50; color: #2e7d32; }
        .alert-info { background: #e3f2fd; border-color: #2196f3; color: #1976d2; }

        .expense-category-badge { padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; display: inline-block; }
        .category-achat { background: #e1bee7; color: #7b1fa2; }
        .category-operation { background: #b2dfdb; color: #00796b; }
        .category-maintenance { background: #ffccbc; color: #e64a19; }
        .category-autre { background: #e0e0e0; color: #424242; }

        .loading-spinner { display: none; text-align: center; padding: 2rem; }
        .loading-spinner.active { display: block; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #5c6bc0; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .sync-status { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.85rem; }
        .sync-status.synced { background: #e8f5e9; color: #2e7d32; }
        .sync-status.syncing { background: #fff3e0; color: #e65100; }
        .sync-status.error { background: #ffebee; color: #d32f2f; }

        .prod-card { background: #fff; border: 2px solid #ecf0f1; border-radius: 8px; padding: 0.5rem; text-align: center; cursor: pointer; transition: all 0.2s; }
        .prod-card:hover { border-color: #5c6bc0; transform: translateY(-2px); }
        .prod-card.selected { border-color: #43a047; background: #e8f5e9; }
        .qty-btn { background: #5c6bc0; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 14px; cursor: pointer; }
        .qty-input { width: 34px; text-align: center; border: 1px solid #cfd8dc; border-radius: 4px; font-size: 0.8rem; }

        @media (max-width: 768px) {
            .header-content { flex-direction: column; align-items: flex-start; }
            .table-container { overflow-x: auto; }
            table { min-width: 1200px; }
            .stats-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>
    <!-- PAGE DE CONNEXION -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <div class="login-header">
                <i class="fas fa-user-lock"></i>
                <h1>Connexion</h1>
                <p>Système de Gestion de Stock ART'RISE</p>
            </div>
            <div class="login-body">
                <div id="connectionStatus"></div>
                <form id="loginForm" onsubmit="login(event)">
                    <div class="form-group">
                        <label>Nom d'utilisateur</label>
                        <input type="text" id="username" placeholder="Entrez votre nom d'utilisateur" required>
                    </div>
                    <div class="form-group">
                        <label>Mot de passe</label>
                        <input type="password" id="password" placeholder="Entrez votre mot de passe" required>
                    </div>
                    <button type="submit" class="btn-login">
                        <i class="fas fa-sign-in-alt"></i> Se Connecter
                    </button>
                </form>
                <div style="margin-top: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 10px; font-size: 0.85rem;">
                    <strong>Comptes de test :</strong><br>
                    Admin: admin / admin123<br>
                    Caissière: caisse / caisse123<br>
                    Sandy: sandy / sandy123
                </div>
            </div>
        </div>
    </div>

    <!-- APPLICATION PRINCIPALE -->
    <div id="appPage" class="app-container">
        <header>
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo"><i class="fas fa-boxes"></i></div>
                    <div>
                        <h1>ART'RISE - Gestion de Stock</h1>
                        <p class="subtitle">Système avancé avec synchronisation cloud</p>
                    </div>
                </div>
                <div class="header-buttons">
                    <div id="syncStatusDisplay" class="sync-status synced">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <span>Synchronisé</span>
                    </div>
                    <div class="user-badge" id="userBadge">
                        <i class="fas fa-user"></i>
                        <span id="currentUser"></span>
                    </div>
                    <button class="btn btn-success" onclick="openQuickSale()" id="btnQuickSale"><i class="fas fa-shopping-cart"></i> Nouvelle Vente</button>
                    <button class="btn btn-warning" onclick="openExpenseModal()" id="btnExpense"><i class="fas fa-file-invoice-dollar"></i> Dépense</button>
                    <button class="btn btn-info" onclick="openStockManagement()" id="btnStock"><i class="fas fa-box"></i> Stock</button>
                    <button class="btn btn-primary" onclick="generateReport()" id="btnReport"><i class="fas fa-chart-bar"></i> Rapport</button>
                    <button class="btn btn-success" onclick="exportToExcel()" id="btnExport"><i class="fas fa-download"></i> Export</button>
                    <button class="btn btn-danger" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Déconnexion</button>
                </div>
            </div>
        </header>

        <div class="container">
            <div id="alertsContainer"></div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-info"><h3>Ventes Aujourd'hui</h3><p id="todaySales">0</p></div>
                    <div class="stat-icon blue"><i class="fas fa-receipt"></i></div>
                </div>
                <div class="stat-card">
                    <div class="stat-info"><h3>CA du Jour</h3><p id="todayRevenue">0 FCFA</p></div>
                    <div class="stat-icon purple"><i class="fas fa-euro-sign"></i></div>
                </div>
                <div class="stat-card">
                    <div class="stat-info"><h3>Dépenses du Jour</h3><p id="todayExpenses">0 FCFA</p></div>
                    <div class="stat-icon red"><i class="fas fa-minus-circle"></i></div>
                </div>
                <div class="stat-card">
                    <div class="stat-info"><h3>Résultat Net</h3><p id="netResult">0 FCFA</p></div>
                    <div class="stat-icon green"><i class="fas fa-balance-scale"></i></div>
                </div>
                <div class="stat-card">
                    <div class="stat-info"><h3>Stock Faible</h3><p id="lowStockCount">0</p></div>
                    <div class="stat-icon orange"><i class="fas fa-exclamation-triangle"></i></div>
                </div>
                <div class="stat-card">
                    <div class="stat-info"><h3>Valeur Stock</h3><p id="stockValue">0 FCFA</p></div>
                    <div class="stat-icon teal"><i class="fas fa-warehouse"></i></div>
                </div>
            </div>

            <div class="search-section">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="Rechercher des ventes..." oninput="filterSales()">
                </div>
            </div>

            <div class="table-container">
                <div class="table-header">
                    <h3><i class="fas fa-shopping-cart"></i> Historique des Ventes</h3>
                </div>
                <div class="loading-spinner" id="salesLoading">
                    <div class="spinner"></div>
                    <p>Chargement des données...</p>
                </div>
                <table id="salesTable">
                    <thead>
                        <tr>
                            <th>Date & Heure</th>
                            <th>Vendeur</th>
                            <th>Produits</th>
                            <th>Quantité</th>
                            <th>Montant</th>
                            <th>Paiement</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="salesTableBody"></tbody>
                </table>
                <div id="noSalesData" class="no-data" style="display: none;">
                    <i class="fas fa-shopping-cart"></i>
                    <p>Aucune vente enregistrée</p>
                </div>
            </div>

            <div class="table-container">
                <div class="table-header">
                    <h3><i class="fas fa-file-invoice-dollar"></i> Fiche des Dépenses</h3>
                </div>
                <div class="loading-spinner" id="expensesLoading">
                    <div class="spinner"></div>
                    <p>Chargement des dépenses...</p>
                </div>
                <table id="expensesTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Catégorie</th>
                            <th>Libellé</th>
                            <th>Référence</th>
                            <th>Quantité</th>
                            <th>Prix Unit.</th>
                            <th>Total</th>
                            <th>Saisi par</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="expensesTableBody"></tbody>
                </table>
                <div id="noExpensesData" class="no-data" style="display: none;">
                    <i class="fas fa-file-invoice"></i>
                    <p>Aucune dépense enregistrée</p>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL VENTE RAPIDE -->
    <div id="quickSaleModal" class="modal">
        <div class="modal-content" style="max-width:900px;">
            <div class="modal-header">
                <h2><i class="fas fa-shopping-cart"></i> Nouvelle Vente</h2>
                <button class="action-btn btn-delete" onclick="closeQuickSale()" style="background:rgba(255,255,255,.2);color:#fff">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="quickProductsGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:0.75rem;margin-bottom:1rem;max-height:45vh;overflow-y:auto;"></div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
                    <div>
                        <h4>Récapitulatif <span id="recapBadge" style="background:#5c6bc0;color:white;padding:.25rem .5rem;border-radius:12px;font-size:.7rem">0 article(s)</span></h4>
                        <div id="quickRecap" style="background:#f5f7fa;border-radius:6px;padding:0.5rem;max-height:120px;overflow-y:auto;"></div>
                    </div>
                    <div>
                        <h4>Paiements</h4>
                        <div class="form-group"><label>OM</label><input id="quickOM" type="number" min="0" step="100" value="0" oninput="balanceQuickPayments()"></div>
                        <div class="form-group"><label>MOMO</label><input id="quickMOMO" type="number" min="0" step="100" value="0" oninput="balanceQuickPayments()"></div>
                        <div class="form-group"><label>CASH</label><input id="quickCASH" type="number" min="0" step="100" value="0" readonly style="background:#e8f5e9;font-weight:bold"></div>
                    </div>
                </div>
                <div style="text-align:center;margin-top:1rem;font-size:1.3rem;font-weight:bold;color:#5c6bc0">
                    TOTAL : <span id="quickTotal">0</span> FCFA
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" onclick="closeQuickSale()">Annuler</button>
                <button class="btn btn-success" onclick="saveQuickSale()"><i class="fas fa-save"></i> Finaliser la vente</button>
            </div>
        </div>
    </div>

    <!-- MODAL DÉPENSES -->
    <div id="expenseModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2><i class="fas fa-plus"></i> <span id="expenseModalTitle">Nouvelle Dépense</span></h2>
                <button class="action-btn btn-delete" onclick="closeExpenseModal()" style="background: rgba(255,255,255,0.2); color: white;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Date *</label>
                    <input type="date" id="expenseDate" required>
                </div>
                <div class="form-group">
                    <label>Catégorie *</label>
                    <select id="expenseCategory" required>
                        <option value="">-- Choisir une catégorie --</option>
                        <option value="achat">Achat de stock</option>
                        <option value="operation">Frais opérationnels</option>
                        <option value="maintenance">Maintenance</option>
                        <option value="autre">Autre</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Libellé *</label>
                    <input type="text" id="expenseLibelle" placeholder="Ex: Achat de Kadji" required>
                </div>
                <div class="form-group">
                    <label>Référence</label>
                    <input type="text" id="expenseReference" placeholder="Ex: Facture #123">
                </div>
                <div class="form-group">
                    <label>Quantité *</label>
                    <input type="number" id="expenseQuantity" min="1" value="1" oninput="calculateExpenseTotal()" required>
                </div>
                <div class="form-group">
                    <label>Prix Unitaire (FCFA) *</label>
                    <input type="number" id="expenseUnitPrice" min="0" step="100" placeholder="Ex: 7800" oninput="calculateExpenseTotal()" required>
                </div>
                <div class="form-group">
                    <label>Total (FCFA)</label>
                    <input type="number" id="expenseTotal" readonly style="background: #e8f5e9; font-weight: bold; font-size: 1.2rem;">
                </div>
                <div class="form-group">
                    <label>Commentaires</label>
                    <textarea id="expenseNotes" rows="3" placeholder="Informations complémentaires..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" onclick="closeExpenseModal()">Annuler</button>
                <button class="btn btn-success" onclick="saveExpense()"><i class="fas fa-save"></i> Enregistrer</button>
            </div>
        </div>
    </div>

    <!-- MODAL GESTION DE STOCK -->
    <div id="stockModal" class="modal">
        <div class="modal-content" style="max-width: 95%;">
            <div class="modal-header">
                <h2><i class="fas fa-box"></i> Gestion des Stocks</h2>
                <button class="action-btn btn-delete" onclick="closeStockModal()" style="background: rgba(255,255,255,0.2); color: white;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button class="btn btn-success" onclick="openAddStockModal()"><i class="fas fa-plus"></i> Entrée de Stock</button>
                    <button class="btn btn-warning" onclick="syncStockData()"><i class="fas fa-sync"></i> Synchroniser</button>
                </div>
                <div class="loading-spinner" id="stockLoading">
                    <div class="spinner"></div>
                    <p>Chargement des stocks...</p>
                </div>
                <table id="stockTable">
                    <thead>
                        <tr>
                            <th>Produit</th>
                            <th>Stock Actuel</th>
                            <th>Seuil d'Alerte</th>
                            <th>Prix</th>
                            <th>Valeur</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="stockTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- MODAL AJOUT STOCK -->
    <div id="addStockModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2><i class="fas fa-plus"></i> Entrée de Stock</h2>
                <button class="action-btn btn-delete" onclick="closeAddStockModal()" style="background: rgba(255,255,255,0.2); color: white;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Produit *</label>
                    <select id="stockProduct" required>
                        <option value="">-- Choisir un produit --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Quantité à ajouter *</label>
                    <input type="number" id="stockQuantity" min="1" value="1" required>
                </div>
                <div class="form-group">
                    <label>Référence</label>
                    <input type="text" id="stockReference" placeholder="Ex: BE2024001">
                </div>
                <div class="form-group">
                    <label>Commentaire</label>
                    <textarea id="stockComment" rows="2" placeholder="Commentaire (optionnel)"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" onclick="closeAddStockModal()">Annuler</button>
                <button class="btn btn-success" onclick="saveStockEntry()"><i class="fas fa-save"></i> Enregistrer</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration Supabase
        const SUPABASE_URL = 'https://plxgyjvqbfihxeikligr.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBseGd5anZxYmZpaHhlaWtsaWdyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5NTExNjksImV4cCI6MjA4MzUyNzE2OX0.SedBD4xHOJp3CSGrAmWlO_ye4TJtw25PPkWxmBkCEvA';
        
        // Variables globales
        var supabaseClient = null;
        var currentUser = null;
        var sales = [];
        var expenses = [];
        var products = [];
        var quickData = {};

        // Initialisation Supabase
        async function initSupabase() {
            try {
                if (!supabaseClient) {
                    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                }
                console.log('✅ Supabase initialisé');
                showAlert('Connexion à la base de données établie', 'success');
                return true;
            } catch (error) {
                console.error('❌ Erreur Supabase:', error);
                showAlert('Erreur de connexion à la base de données', 'danger');
                return false;
            }
        }

        // Users
        const users = {
            admin: { password: 'admin123', role: 'admin', name: 'Administrateur' },
            caisse: { password: 'caisse123', role: 'cashier', name: 'Caissière' },
            sandy: { password: 'sandy123', role: 'server', name: 'Sandy' },
            leslie: { password: 'leslie123', role: 'server', name: 'Leslie' },
            rosia: { password: 'rosia123', role: 'server', name: 'Rosia' }
        };

        // Produits
        const productCatalog = [
            {code: 'kadji', name: 'Kadji', price: 1000, stock: 50, alertThreshold: 10},
            {code: 'mutzig', name: 'Mutzig', price: 1200, stock: 50, alertThreshold: 10},
            {code: 'origin', name: 'Origin', price: 1500, stock: 50, alertThreshold: 10},
            {code: 'malta', name: 'Malta', price: 800, stock: 50, alertThreshold: 10},
            {code: 'guinness_gm', name: 'Guinness GM', price: 1800, stock: 50, alertThreshold: 10},
            {code: 'guinness_pm', name: 'Guinness PM', price: 1600, stock: 50, alertThreshold: 10},
            {code: 'ice_black', name: 'Ice Black', price: 1400, stock: 50, alertThreshold: 10},
            {code: 'beaufort', name: 'Beaufort', price: 2200, stock: 50, alertThreshold: 10},
            {code: 'heineken', name: 'Heineken', price: 1800, stock: 50, alertThreshold: 10}
        ];

        // Connexion
        async function login(event) {
            event.preventDefault();
            const username = document.getElementById('username').value.toLowerCase();
            const password = document.getElementById('password').value;

            if (users[username] && users[username].password === password) {
                currentUser = { 
                    username: username, 
                    role: users[username].role, 
                    name: users[username].name 
                };
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('appPage').classList.add('active');
                await initApp();
            } else {
                showAlert('Identifiants incorrects !', 'danger');
            }
        }

        function logout() {
            if (confirm('Voulez-vous vraiment vous déconnecter ?')) {
                currentUser = null;
                document.getElementById('appPage').classList.remove('active');
                document.getElementById('loginPage').style.display = 'flex';
                document.getElementById('loginForm').reset();
            }
        }

        // Initialisation
        async function initApp() {
            document.getElementById('currentUser').textContent = currentUser.name;
            const badge = document.getElementById('userBadge');
            badge.className = 'user-badge role-' + currentUser.role;

            products = [...productCatalog];
            
            // Charger les données
            await loadSales();
            await loadExpenses();
            updateStats();
            checkLowStock();
        }

        // GESTION DES VENTES
        async function loadSales() {
            try {
                document.getElementById('salesLoading').classList.add('active');
                
                const { data, error } = await supabaseClient
                    .from('sales')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                sales = data || [];
                renderSales();
                document.getElementById('noSalesData').style.display = sales.length === 0 ? 'block' : 'none';
            } catch (error) {
                console.error('Erreur chargement ventes:', error);
                showAlert('Erreur lors du chargement des ventes', 'danger');
            } finally {
                document.getElementById('salesLoading').classList.remove('active');
            }
        }

        function renderSales() {
            const tbody = document.getElementById('salesTableBody');
            let html = '';

            sales.forEach(sale => {
                const productsText = sale.products ? sale.products.join(', ') : '';
                const paymentInfo = [];
                if (sale.payment_om > 0) paymentInfo.push(`OM: ${sale.payment_om.toLocaleString()}`);
                if (sale.payment_momo > 0) paymentInfo.push(`MOMO: ${sale.payment_momo.toLocaleString()}`);
                if (sale.payment_cash > 0) paymentInfo.push(`CASH: ${sale.payment_cash.toLocaleString()}`);

                html += `
                    <tr>
                        <td>${formatDateTime(sale.created_at)}</td>
                        <td><strong>${sale.server_name}</strong></td>
                        <td style="font-size:0.75rem">${productsText}</td>
                        <td style="text-align:center">${sale.quantity}</td>
                        <td style="text-align:right"><strong>${sale.total_amount.toLocaleString()} FCFA</strong></td>
                        <td style="font-size:0.75rem">${paymentInfo.join('<br>')}</td>
                        <td style="text-align:center">
                            <button class="action-btn btn-delete" onclick="deleteSale(${sale.id})" title="Supprimer">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        async function deleteSale(saleId) {
            if (!confirm('Supprimer cette vente ?')) return;

            try {
                const { error } = await supabaseClient
                    .from('sales')
                    .delete()
                    .eq('id', saleId);

                if (error) throw error;

                showAlert('Vente supprimée avec succès', 'success');
                await loadSales();
                updateStats();
            } catch (error) {
                console.error('Erreur suppression:', error);
                showAlert('Erreur lors de la suppression', 'danger');
            }
        }

        // GESTION DES DÉPENSES
        async function loadExpenses() {
            try {
                document.getElementById('expensesLoading').classList.add('active');
                
                const { data, error } = await supabaseClient
                    .from('expenses')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                expenses = data || [];
                renderExpenses();
                document.getElementById('noExpensesData').style.display = expenses.length === 0 ? 'block' : 'none';
            } catch (error) {
                console.error('Erreur chargement dépenses:', error);
                showAlert('Erreur lors du chargement des dépenses', 'danger');
            } finally {
                document.getElementById('expensesLoading').classList.remove('active');
            }
        }

        function renderExpenses() {
            const tbody = document.getElementById('expensesTableBody');
            let html = '';

            expenses.forEach(expense => {
                const categoryBadge = getCategoryBadge(expense.category);
                
                html += `
                    <tr>
                        <td>${formatDate(expense.expense_date)}</td>
                        <td>${categoryBadge}</td>
                        <td><strong>${expense.libelle}</strong>${expense.notes ? '<br><small style="color:#7f8c8d">' + expense.notes + '</small>' : ''}</td>
                        <td>${expense.reference || '-'}</td>
                        <td style="text-align:center">${expense.quantity}</td>
                        <td style="text-align:right">${expense.unit_price.toLocaleString()} FCFA</td>
                        <td style="text-align:right"><strong>${expense.total.toLocaleString()} FCFA</strong></td>
                        <td style="text-align:center"><small>${expense.user_name}</small></td>
                        <td style="text-align:center">
                            <button class="action-btn btn-delete" onclick="deleteExpense(${expense.id})" title="Supprimer">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        function getCategoryBadge(category) {
            const badges = {
                'achat': '<span class="expense-category-badge category-achat">Achat Stock</span>',
                'operation': '<span class="expense-category-badge category-operation">Opérationnel</span>',
                'maintenance': '<span class="expense-category-badge category-maintenance">Maintenance</span>',
                'autre': '<span class="expense-category-badge category-autre">Autre</span>'
            };
            return badges[category] || badges['autre'];
        }

        async function deleteExpense(expenseId) {
            if (!confirm('Supprimer cette dépense ?')) return;

            try {
                const { error } = await supabaseClient
                    .from('expenses')
                    .delete()
                    .eq('id', expenseId);

                if (error) throw error;

                showAlert('Dépense supprimée avec succès', 'success');
                await loadExpenses();
                updateStats();
            } catch (error) {
                console.error('Erreur suppression:', error);
                showAlert('Erreur lors de la suppression', 'danger');
            }
        }

        // MODAL DÉPENSE
        function openExpenseModal() {
            document.getElementById('expenseModalTitle').textContent = 'Nouvelle Dépense';
            document.getElementById('expenseDate').value = getCurrentDateISO();
            document.getElementById('expenseCategory').value = '';
            document.getElementById('expenseLibelle').value = '';
            document.getElementById('expenseReference').value = '';
            document.getElementById('expenseQuantity').value = '1';
            document.getElementById('expenseUnitPrice').value = '';
            document.getElementById('expenseTotal').value = '0';
            document.getElementById('expenseNotes').value = '';
            document.getElementById('expenseModal').classList.add('active');
        }

        function closeExpenseModal() {
            document.getElementById('expenseModal').classList.remove('active');
        }

        function calculateExpenseTotal() {
            const quantity = parseInt(document.getElementById('expenseQuantity').value) || 0;
            const unitPrice = parseFloat(document.getElementById('expenseUnitPrice').value) || 0;
            document.getElementById('expenseTotal').value = quantity * unitPrice;
        }

        async function saveExpense() {
            const date = document.getElementById('expenseDate').value;
            const category = document.getElementById('expenseCategory').value;
            const libelle = document.getElementById('expenseLibelle').value.trim();
            const reference = document.getElementById('expenseReference').value.trim();
            const quantity = parseInt(document.getElementById('expenseQuantity').value) || 1;
            const unitPrice = parseFloat(document.getElementById('expenseUnitPrice').value) || 0;
            const notes = document.getElementById('expenseNotes').value.trim();

            if (!category || !libelle || unitPrice <= 0) {
                showAlert('Veuillez remplir tous les champs obligatoires', 'warning');
                return;
            }

            try {
                updateSyncStatus('syncing');
                
                const expenseData = {
                    expense_date: date,
                    category: category,
                    libelle: libelle,
                    reference: reference,
                    quantity: quantity,
                    unit_price: unitPrice,
                    total: quantity * unitPrice,
                    notes: notes,
                    user_name: currentUser.name
                };

                const { data, error } = await supabaseClient
                    .from('expenses')
                    .insert([expenseData])
                    .select();

                if (error) throw error;

                showAlert('Dépense enregistrée avec succès !', 'success');
                closeExpenseModal();
                await loadExpenses();
                updateStats();
                updateSyncStatus('synced');
            } catch (error) {
                console.error('Erreur sauvegarde:', error);
                showAlert('Erreur lors de l\'enregistrement', 'danger');
                updateSyncStatus('error');
            }
        }

        // VENTE RAPIDE
        function openQuickSale() {
            buildProductsGrid();
            resetQuickData();
            document.getElementById('quickSaleModal').classList.add('active');
        }

        function closeQuickSale() {
            document.getElementById('quickSaleModal').classList.remove('active');
        }

        function resetQuickData() {
            quickData = {};
            document.getElementById('quickOM').value = 0;
            document.getElementById('quickMOMO').value = 0;
            document.getElementById('quickCASH').value = 0;
            updateQuickTotal();
        }

        function buildProductsGrid() {
            const grid = document.getElementById('quickProductsGrid');
            grid.innerHTML = '';
            
            products.forEach(p => {
                const card = document.createElement('div');
                card.className = 'prod-card';
                card.innerHTML = `
                    <div style="font-weight:600;font-size:0.8rem">${p.name}</div>
                    <div style="font-size:0.75rem;color:#7f8c8d">${p.price.toLocaleString()} FCFA</div>
                    <div style="font-size:0.7rem;color:${p.stock<=p.alertThreshold?'#f44336':'#4caf50'}">Stock: ${p.stock}</div>
                    <div style="display:flex;align-items:center;justify-content:center;margin-top:0.4rem;gap:0.25rem">
                        <button class="qty-btn" onclick="changeQty('${p.code}',-1)">-</button>
                        <input type="number" class="qty-input" id="q_${p.code}" value="0" min="0" readonly>
                        <button class="qty-btn" onclick="changeQty('${p.code}',1)">+</button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function changeQty(code, delta) {
            const input = document.getElementById('q_' + code);
            const prod = products.find(x => x.code === code);
            let v = parseInt(input.value) || 0;
            v += delta;
            
            if (v < 0) v = 0;
            if (v > prod.stock) {
                showAlert(`Stock insuffisant! Disponible: ${prod.stock}`, 'warning');
                return;
            }
            
            input.value = v;
            quickData[code] = { name: prod.name, price: prod.price, qty: v };
            updateQuickTotal();
        }

        function updateQuickTotal() {
            let total = 0, items = 0, recap = '';
            
            for (const c in quickData) {
                if (quickData[c].qty > 0) {
                    const sub = quickData[c].price * quickData[c].qty;
                    total += sub;
                    items += quickData[c].qty;
                    recap += `<div style="display:flex;justify-content:space-between;padding:0.25rem 0.5rem;font-size:0.8rem"><span>${quickData[c].name} ×${quickData[c].qty}</span><span>${sub.toLocaleString()}</span></div>`;
                }
            }
            
            document.getElementById('quickRecap').innerHTML = recap || '<div style="color:#95a5a6;text-align:center">Aucun produit sélectionné</div>';
            document.getElementById('quickTotal').textContent = total.toLocaleString();
            document.getElementById('recapBadge').textContent = items + ' article(s)';
            balanceQuickPayments();
        }

        function balanceQuickPayments() {
            const total = parseInt(document.getElementById('quickTotal').textContent.replace(/\s/g, '')) || 0;
            const om = parseInt(document.getElementById('quickOM').value) || 0;
            const momo = parseInt(document.getElementById('quickMOMO').value) || 0;
            const cash = Math.max(0, total - om - momo);
            document.getElementById('quickCASH').value = cash;
        }

        async function saveQuickSale() {
            const items = [];
            const stockUpdates = {};
            
            for (const c in quickData) {
                if (quickData[c].qty > 0) {
                    for (let i = 0; i < quickData[c].qty; i++) items.push(c);
                    stockUpdates[c] = quickData[c].qty;
                }
            }
            
            if (items.length === 0) {
                showAlert('Aucun produit sélectionné', 'warning');
                return;
            }

            const total = parseInt(document.getElementById('quickTotal').textContent.replace(/\s/g, '')) || 0;
            const om = parseInt(document.getElementById('quickOM').value) || 0;
            const momo = parseInt(document.getElementById('quickMOMO').value) || 0;
            const cash = parseInt(document.getElementById('quickCASH').value) || 0;
            
            if (om + momo + cash !== total) {
                showAlert('La répartition des paiements est incorrecte', 'warning');
                return;
            }

            try {
                updateSyncStatus('syncing');

                // Mettre à jour le stock local
                for (const code in stockUpdates) {
                    const prod = products.find(p => p.code === code);
                    if (prod) prod.stock -= stockUpdates[code];
                }

                const saleData = {
                    server_name: currentUser.name,
                    server_username: currentUser.username,
                    quantity: items.length,
                    products: items,
                    unit_price: Math.round(total / items.length),
                    total_amount: total,
                    payment_om: om,
                    payment_momo: momo,
                    payment_cash: cash
                };

                const { data, error } = await supabaseClient
                    .from('sales')
                    .insert([saleData])
                    .select();

                if (error) throw error;

                showAlert('Vente enregistrée avec succès !', 'success');
                closeQuickSale();
                await loadSales();
                updateStats();
                updateSyncStatus('synced');
            } catch (error) {
                console.error('Erreur sauvegarde vente:', error);
                showAlert('Erreur lors de l\'enregistrement', 'danger');
                updateSyncStatus('error');
            }
        }

        // GESTION STOCK
        function openStockManagement() {
            renderStockTable();
            document.getElementById('stockModal').classList.add('active');
        }

        function closeStockModal() {
            document.getElementById('stockModal').classList.remove('active');
        }

        function renderStockTable() {
            const tbody = document.getElementById('stockTableBody');
            let html = '';

            products.forEach(prod => {
                const statusClass = prod.stock <= prod.alertThreshold ? 'stock-low' : 'stock-ok';
                const statusText = prod.stock <= prod.alertThreshold ? 'Stock faible' : 'OK';
                const value = prod.stock * prod.price;

                html += `
                    <tr>
                        <td><strong>${prod.name}</strong><br><small style="color:#7f8c8d">${prod.code}</small></td>
                        <td style="text-align:center"><span class="${statusClass}">${prod.stock}</span></td>
                        <td style="text-align:center">${prod.alertThreshold}</td>
                        <td style="text-align:right">${prod.price.toLocaleString()} FCFA</td>
                        <td style="text-align:right">${value.toLocaleString()} FCFA</td>
                        <td style="text-align:center"><span style="padding:0.25rem 0.5rem;border-radius:4px;font-size:0.75rem;font-weight:600;background:${prod.stock <= prod.alertThreshold ? '#ffebee' : '#e8f5e9'};color:${prod.stock <= prod.alertThreshold ? '#d32f2f' : '#2e7d32'}">${statusText}</span></td>
                        <td style="text-align:center">
                            <button class="action-btn btn-edit" onclick="openAddStockModal('${prod.code}')" title="Ajouter du stock">
                                <i class="fas fa-plus"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        function openAddStockModal(productCode) {
            const select = document.getElementById('stockProduct');
            select.innerHTML = '<option value="">-- Choisir un produit --</option>';

            products.forEach(prod => {
                const option = document.createElement('option');
                option.value = prod.code;
                option.textContent = `${prod.name} (${prod.stock} en stock)`;
                if (productCode && prod.code === productCode) {
                    option.selected = true;
                }
                select.appendChild(option);
            });

            document.getElementById('addStockModal').classList.add('active');
        }

        function closeAddStockModal() {
            document.getElementById('addStockModal').classList.remove('active');
        }

        async function saveStockEntry() {
            const productCode = document.getElementById('stockProduct').value;
            const quantity = parseInt(document.getElementById('stockQuantity').value);
            
            if (!productCode || quantity <= 0) {
                showAlert('Veuillez remplir tous les champs', 'warning');
                return;
            }

            const prod = products.find(p => p.code === productCode);
            if (!prod) return;

            prod.stock += quantity;
            
            showAlert(`Stock mis à jour : ${prod.name} (+${quantity}) = ${prod.stock}`, 'success');
            closeAddStockModal();
            renderStockTable();
            updateStats();
        }

        // STATISTIQUES
        function updateStats() {
            const today = getCurrentDate();
            
            // Ventes du jour
            const todaySales = sales.filter(s => formatDate(s.created_at) === today);
            const todayRevenue = todaySales.reduce((sum, s) => sum + s.total_amount, 0);
            
            // Dépenses du jour
            const todayExpenses = expenses.filter(e => formatDate(e.expense_date) === today);
            const todayExpensesTotal = todayExpenses.reduce((sum, e) => sum + e.total, 0);
            
            // Résultat net
            const netResult = todayRevenue - todayExpensesTotal;
            
            // Stock
            const lowStock = products.filter(p => p.stock <= p.alertThreshold).length;
            const stockValue = products.reduce((sum, p) => sum + (p.stock * p.price), 0);

            document.getElementById('todaySales').textContent = todaySales.length;
            document.getElementById('todayRevenue').textContent = todayRevenue.toLocaleString() + ' FCFA';
            document.getElementById('todayExpenses').textContent = todayExpensesTotal.toLocaleString() + ' FCFA';
            document.getElementById('netResult').textContent = netResult.toLocaleString() + ' FCFA';
            document.getElementById('netResult').style.color = netResult >= 0 ? '#4caf50' : '#f44336';
            document.getElementById('lowStockCount').textContent = lowStock;
            document.getElementById('stockValue').textContent = stockValue.toLocaleString() + ' FCFA';
        }

        function checkLowStock() {
            const lowStock = products.filter(p => p.stock <= p.alertThreshold);
            if (lowStock.length > 0) {
                const names = lowStock.map(p => p.name).join(', ');
                showAlert(`⚠️ Stock faible pour : ${names}`, 'warning');
            }
        }

        // RAPPORTS
        async function generateReport() {
            try {
                const today = getCurrentDate();
                
                // Calculs
                const todaySales = sales.filter(s => formatDate(s.created_at) === today);
                const todayRevenue = todaySales.reduce((sum, s) => sum + s.total_amount, 0);
                const todayExpenses = expenses.filter(e => formatDate(e.expense_date) === today);
                const todayExpensesTotal = todayExpenses.reduce((sum, e) => sum + e.total, 0);
                
                const report = {
                    date: today,
                    ventes: todaySales.length,
                    chiffre_affaires: todayRevenue,
                    depenses: todayExpensesTotal,
                    resultat_net: todayRevenue - todayExpensesTotal,
                    details_ventes: todaySales,
                    details_depenses: todayExpenses
                };
                
                showAlert(`📊 Rapport du ${today} généré avec succès`, 'success');
                console.log('Rapport:', report);
                
                // Créer un rapport détaillé
                let reportHTML = `
                    <div style="background:white;padding:2rem;border-radius:12px;max-width:800px;margin:2rem auto">
                        <h2 style="text-align:center;color:#2c3e50;margin-bottom:2rem">📊 Rapport Journalier - ${today}</h2>
                        
                        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;margin-bottom:2rem">
                            <div style="background:#e3f2fd;padding:1rem;border-radius:8px">
                                <h4 style="color:#1976d2">Ventes</h4>
                                <p style="font-size:1.5rem;font-weight:bold">${todaySales.length}</p>
                            </div>
                            <div style="background:#e8f5e9;padding:1rem;border-radius:8px">
                                <h4 style="color:#2e7d32">Chiffre d'Affaires</h4>
                                <p style="font-size:1.5rem;font-weight:bold">${todayRevenue.toLocaleString()} FCFA</p>
                            </div>
                            <div style="background:#ffebee;padding:1rem;border-radius:8px">
                                <h4 style="color:#d32f2f">Dépenses</h4>
                                <p style="font-size:1.5rem;font-weight:bold">${todayExpensesTotal.toLocaleString()} FCFA</p>
                            </div>
                            <div style="background:#f3e5f5;padding:1rem;border-radius:8px">
                                <h4 style="color:#7b1fa2">Résultat Net</h4>
                                <p style="font-size:1.5rem;font-weight:bold;color:${report.resultat_net >= 0 ? '#4caf50' : '#f44336'}">${report.resultat_net.toLocaleString()} FCFA</p>
                            </div>
                        </div>
                        
                        <div style="margin-bottom:1rem">
                            <h3 style="color:#2c3e50;margin-bottom:1rem">Détails des Ventes</h3>
                            ${todaySales.length > 0 ? todaySales.map(s => `
                                <div style="border-bottom:1px solid #ecf0f1;padding:0.5rem 0">
                                    <strong>${s.server_name}</strong> - ${s.quantity} articles - ${s.total_amount.toLocaleString()} FCFA
                                </div>
                            `).join('') : '<p style="color:#95a5a6">Aucune vente</p>'}
                        </div>
                        
                        <div>
                            <h3 style="color:#2c3e50;margin-bottom:1rem">Détails des Dépenses</h3>
                            ${todayExpenses.length > 0 ? todayExpenses.map(e => `
                                <div style="border-bottom:1px solid #ecf0f1;padding:0.5rem 0">
                                    <strong>${e.libelle}</strong> - ${e.quantity} × ${e.unit_price.toLocaleString()} = ${e.total.toLocaleString()} FCFA
                                </div>
                            `).join('') : '<p style="color:#95a5a6">Aucune dépense</p>'}
                        </div>
                    </div>
                `;
                
                // Afficher dans une alerte
                const reportWindow = window.open('', '_blank');
                reportWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Rapport ${today}</title>
                        <meta charset="UTF-8">
                        <style>
                            body { font-family: 'Segoe UI', sans-serif; background: #f5f7fa; margin: 0; padding: 20px; }
                            @media print { body { background: white; } }
                        </style>
                    </head>
                    <body>
                        ${reportHTML}
                        <div style="text-align:center;margin-top:2rem">
                            <button onclick="window.print()" style="padding:0.75rem 1.5rem;background:#5c6bc0;color:white;border:none;border-radius:8px;cursor:pointer;font-size:1rem">
                                🖨️ Imprimer
                            </button>
                        </div>
                    </body>
                    </html>
                `);
                
            } catch (error) {
                console.error('Erreur génération rapport:', error);
                showAlert('Erreur lors de la génération du rapport', 'danger');
            }
        }

        // EXPORT EXCEL
        async function exportToExcel() {
            try {
                const wb = XLSX.utils.book_new();
                
                // Feuille Ventes
                const salesData = sales.map(s => ({
                    'Date': formatDateTime(s.created_at),
                    'Vendeur': s.server_name,
                    'Quantité': s.quantity,
                    'Montant': s.total_amount,
                    'OM': s.payment_om,
                    'MOMO': s.payment_momo,
                    'CASH': s.payment_cash
                }));
                const wsSales = XLSX.utils.json_to_sheet(salesData);
                XLSX.utils.book_append_sheet(wb, wsSales, 'Ventes');
                
                // Feuille Dépenses
                const expensesData = expenses.map(e => ({
                    'Date': formatDate(e.expense_date),
                    'Catégorie': e.category,
                    'Libellé': e.libelle,
                    'Référence': e.reference || '',
                    'Quantité': e.quantity,
                    'Prix Unitaire': e.unit_price,
                    'Total': e.total,
                    'Saisi par': e.user_name
                }));
                const wsExpenses = XLSX.utils.json_to_sheet(expensesData);
                XLSX.utils.book_append_sheet(wb, wsExpenses, 'Dépenses');
                
                // Feuille Stock
                const stockData = products.map(p => ({
                    'Code': p.code,
                    'Produit': p.name,
                    'Stock': p.stock,
                    'Seuil Alerte': p.alertThreshold,
                    'Prix': p.price,
                    'Valeur': p.stock * p.price
                }));
                const wsStock = XLSX.utils.json_to_sheet(stockData);
                XLSX.utils.book_append_sheet(wb, wsStock, 'Stock');
                
                // Télécharger
                const filename = `export_artrise_${getCurrentDate().replace(/\//g, '-')}.xlsx`;
                XLSX.writeFile(wb, filename);
                
                showAlert('✅ Export Excel réussi !', 'success');
            } catch (error) {
                console.error('Erreur export:', error);
                showAlert('Erreur lors de l\'export', 'danger');
            }
        }

        // SYNCHRONISATION
        async function syncStockData() {
            try {
                updateSyncStatus('syncing');
                showAlert('🔄 Synchronisation en cours...', 'info');
                
                // Recharger toutes les données
                await loadSales();
                await loadExpenses();
                
                updateStats();
                checkLowStock();
                
                updateSyncStatus('synced');
                showAlert('✅ Synchronisation réussie !', 'success');
            } catch (error) {
                console.error('Erreur sync:', error);
                updateSyncStatus('error');
                showAlert('❌ Erreur de synchronisation', 'danger');
            }
        }

        function updateSyncStatus(status) {
            const statusDiv = document.getElementById('syncStatusDisplay');
            statusDiv.className = 'sync-status ' + status;
            
            if (status === 'synced') {
                statusDiv.innerHTML = '<i class="fas fa-check-circle"></i><span>Synchronisé</span>';
            } else if (status === 'syncing') {
                statusDiv.innerHTML = '<i class="fas fa-sync fa-spin"></i><span>Synchronisation...</span>';
            } else if (status === 'error') {
                statusDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i><span>Erreur</span>';
            }
        }

        // UTILITAIRES
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i> ${message}`;
            
            const container = document.getElementById('alertsContainer');
            container.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.style.transition = 'opacity 0.5s';
                alertDiv.style.opacity = '0';
                setTimeout(() => alertDiv.remove(), 500);
            }, 5000);
        }

        function filterSales() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filteredSales = sales.filter(s => 
                s.server_name.toLowerCase().includes(searchTerm) ||
                (s.products && s.products.some(p => p.toLowerCase().includes(searchTerm)))
            );
            
            // Re-render avec les résultats filtrés
            const tbody = document.getElementById('salesTableBody');
            let html = '';
            
            filteredSales.forEach(sale => {
                const productsText = sale.products ? sale.products.join(', ') : '';
                const paymentInfo = [];
                if (sale.payment_om > 0) paymentInfo.push(`OM: ${sale.payment_om.toLocaleString()}`);
                if (sale.payment_momo > 0) paymentInfo.push(`MOMO: ${sale.payment_momo.toLocaleString()}`);
                if (sale.payment_cash > 0) paymentInfo.push(`CASH: ${sale.payment_cash.toLocaleString()}`);

                html += `
                    <tr>
                        <td>${formatDateTime(sale.created_at)}</td>
                        <td><strong>${sale.server_name}</strong></td>
                        <td style="font-size:0.75rem">${productsText}</td>
                        <td style="text-align:center">${sale.quantity}</td>
                        <td style="text-align:right"><strong>${sale.total_amount.toLocaleString()} FCFA</strong></td>
                        <td style="font-size:0.75rem">${paymentInfo.join('<br>')}</td>
                        <td style="text-align:center">
                            <button class="action-btn btn-delete" onclick="deleteSale(${sale.id})" title="Supprimer">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html || '<tr><td colspan="7" style="text-align:center;color:#95a5a6;padding:2rem">Aucun résultat</td></tr>';
        }

        function getCurrentDate() {
            const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function getCurrentDateISO() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function formatDateTime(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${day}/${month}/${year} ${hours}:${minutes}`;
        }

        // INITIALISATION AU CHARGEMENT
        window.onload = async function() {
            console.log('🚀 Initialisation ART\'RISE...');
            const connected = await initSupabase();
            
            if (connected) {
                document.getElementById('connectionStatus').innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i> Connexion à la base de données établie
                    </div>
                `;
            } else {
                document.getElementById('connectionStatus').innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> Mode hors ligne - Les données ne seront pas synchronisées
                    </div>
                `;
            }
        };

        // Fermer les modales en cliquant à l'extérieur
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        };
    </script>
</body>
</html>
